# AI Workflow

## Session Start

1. Check if `ad.yaml` exists
   - No → Auto-initialize (see below)
   - Yes → Continue

2. Read `ad.yaml`: domain, mode, context_files, active_features, agents
3. Read README.md
4. Read all context_files
5. List active features
6. Ask user which feature to work on
7. Read feature `ad.yaml` and context_files
8. Present status

## Auto-Initialization

### Step 1: Analyze Project

```bash
git status  # Check git repo
ls README.md docs/ src/  # Check structure
find . -name "*.md" | wc -l  # Count docs
```

Detect: git status, directories, file count, project type

### Step 2: Ask User

```
AI: "No ad.yaml found. Initialize AD?

    Detected: [project analysis]

    Questions:
    1. Domain? (software | book | marketing | event | product | research | course | game)
    2. Mode? (feature | project)
    3. Detect existing features? (yes | no)
    4. Reorganize markdown files into docs/? (yes | no)
    5. Use multi-agent? (yes | no)

    Answer: "
```

### Step 3: Infer State

**Domain**: Use user answer or infer from structure
**Phase**: Infer from codebase state (DEFINE if minimal, BUILD if substantial code)
**Features**: Analyze src/ subdirectories, git branches
**Agents**: If user wants multi-agent:

```python
if user_answer_5 != "a":
    return {"enabled": False}

# Detect significant directories (>3 files or >100 lines total)
agents = []
for dir in find_dirs("src/*/", "docs/*/", "*/"):
    if is_significant(dir):
        agents.append({
            "id": to_kebab(dir),
            "role": infer_role(dir),
            "description": f"Works on {dir}",
            "context_dirs": [dir]
        })

return {
    "enabled": len(agents) > 0,
    "platform": "claude-sdk",
    "default_execution_mode": "parallel",
    "default_coordination": "message-passing",
    "team": agents
}
```

### Step 4: Reorganize Files (if user said yes)

```bash
mkdir -p docs/active docs/completed docs/planning docs/archived

# Categorize existing .md files by content keywords
# Move to appropriate location (decisions.md, interfaces.md, etc.)
```

### Step 5: Create ad.yaml

```bash
# Generate agents from detected structure
agents_section=$(python3 <<EOF
import yaml
agents = inferred_agents  # From Step 3
print(yaml.dump({"agents": agents}, default_flow_style=False))
EOF
)

cat > ad.yaml << EOF
# Auto-generated by AD initialization
# Date: $(date -Iseconds)

domain: "$inferred_domain"
mode: "$user_chosen_mode"

context_files:
  - "README.md"
  - "docs/decisions.md"
  - "docs/conventions.md"

active_features:
$(for feature in $inferred_features; do
    echo "  - path: \"docs/active/$feature_id\""
    echo "    description: \"$feature_description\""
    echo "    status: \"in-progress\""
done)

completed_features: []

$agents_section

settings:
  auto_commit: true
EOF
```

### Step 6: Create Feature ad.yaml Files

```bash
for feature in $inferred_features; do
    mkdir -p "docs/active/$feature_id"
    cat > "docs/active/$feature_id/ad.yaml" << EOF
id: "$feature_id"
type: "feat"
description: "$feature_description"
phase: "$inferred_phase"
version: "v0.$phase_number.0"
status: "in-progress"
context_files: []
code_locations:
$(for code_path in $feature_code_paths; do
    echo "  - \"$code_path\""
done)
tasks: []
agents:
  enabled: false
notes:
  - "Auto-generated during AD initialization"
EOF
done
```

### Step 7: Create Initial Docs

```bash
cat > docs/journal.md << EOF
# Project Journal

## $(date +%Y-%m-%d) - AD Initialization

- Action: Initialized AD for existing project
- Domain: $domain
- Mode: $mode
- Features: $feature_count
- Phase: $inferred_phase

### Next Steps
- Review ad.yaml
- Continue development with AD workflow
EOF

[ ! -f "docs/decisions.md" ] && cat > docs/decisions.md << EOF
# Architecture Decision Records

## $(date +%Y-%m-%d) - Initialize AD Methodology

**Status**: Accepted
**Context**: Project existed without structured methodology.
**Decision**: Adopt Agentic Driven (AD) methodology.
**Consequences**: Structured workflow, feature-driven development, better documentation.
EOF

[ ! -f "docs/conventions.md" ] && cat > docs/conventions.md << EOF
# Project Conventions

## Git Workflow
- Use Conventional Commits
- One feature per branch
- Commit frequently

## Documentation
- All docs in docs/
- Feature docs in docs/active/feature-name/
- Follow AD phase structure
EOF
```

### Step 8: Commit

```bash
git add .
git commit -m "chore: initialize AD methodology

- Created ad.yaml (domain: $domain, mode: $mode)
- Reorganized documentation into docs/
- Created $feature_count feature ad.yaml files
- Current phase: $inferred_phase

Auto-initialized by AD system.

Co-Authored-By: Claude <noreply@anthropic.com>"
```

### Step 9: Report

```
AI: "✓ AD initialized: $domain ($mode)
    Features: $feature_count
    Agents: $agent_count detected
    Phase: $inferred_phase

    Review ad.yaml and start working"
```

### Special Cases

**No Git**: Prompt to initialize git first
**Very Early Project**: Create minimal ad.yaml with no features
**Mature Project**: Reorganize carefully, preserve structure

## During Work

**Before changes**: Read files, check contracts, verify directory
**After task**: Verify works, update docs, update ad.yaml, update journal.md, commit, update user

### ad.yaml Update Rules

#### NEVER Modify (Root ad.yaml)
- `domain`
- `mode`
- `version`
- `settings` (unless user asks)

#### Allowed (Root ad.yaml)
- Add/update `active_features`
- Move features to `completed_features`
- Add `context_files` (with user permission)

#### ALWAYS Update (Feature ad.yaml)
- Advance phase and version
- Add context_files when creating docs
- Add code_locations when creating code
- Update tasks status

#### Validation
```bash
yq eval ad.yaml > /dev/null 2>&1 || { git restore ad.yaml; exit 1; }
```

## Session End

**Clean**: Commit all completed work, update journal.md, push if ready
**Interrupted**: Commit with `wip:`, update journal noting incomplete work

## Multi-Agent

If agents enabled:
- Identify your agent ID
- Stay in context directories
- Read contracts before implementing
- Use mocks for dependencies
- Don't touch other agents' files
